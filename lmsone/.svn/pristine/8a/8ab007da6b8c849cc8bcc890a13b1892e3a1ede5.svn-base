<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.happyjob.study.lec.dao.LectureFeedbackDAO">

	<!-- 강의피드백 목록 총건 -->
	<select id="feedbackListCnt" resultType="int" parameterType="map">

		select COUNT(*) FROM tb_classinfo ci
		inner join
		(select ap.loginID, ap.class_no, ui.name FROM tb_appraisal ap
			inner join
			(select loginID, name from tb_userinfo) ui
			on ap.loginID = ui.loginID
		) app
		on ci.class_no = app.class_no
		
		inner join
		(select loginID, name from tb_userinfo) ui2
		on ci.loginID = ui2.loginID
		<where>
			<if test="(!oname.equals('') and (oname eq 'A'.toString()))">			  
				and ui2.name like concat('%', #{sname}, '%')
			</if>
			
			<if test="(!oname.equals('')) and oname eq 'B'.toString()">			  
				and app.name like concat('%', #{sname}, '%')
			</if>
			<if test="(!search_startdate.equals('') and (!search_enddate.equals('')))">		  
				and ci.class_enddate between #{search_startdate} and #{search_enddate}
			</if>

		</where>
	</select>
	
	<!-- 강의피드백 목록조회  -->
	<select id="feedbackListSelect" resultType="map" parameterType="map">
		select app.appraisal_no, cl.class_no as class_no, cii.class_nm as class_nm, cii.class_enddate as class_enddate, cii.name as t_name, app.name as s_name, app.appraisal_score as appraisal_score, cr.room_nm as room_nm
		FROM tb_courselist cl
		
		inner join
		  (select ci.class_no, ci.class_nm, ci.class_enddate ,ci.loginID, ui.name
		  FROM tb_classinfo ci
		    inner join
		    (select loginID, name FROM tb_userinfo) ui
		    on ci.loginID = ui.loginID
		  ) cii
		  on cl.class_no = cii.class_no
		  
		
		inner join
		  (select ap.appraisal_no, ap.class_no, ap.loginID, ap.appraisal_score, ui2.name FROM tb_appraisal ap
		    inner join
		    (select loginID, name FROM tb_userinfo) ui2
		    on ap.loginID = ui2.loginID
		  ) app
		  on cl.class_no = app.class_no
		
		inner join
		  (select class_no, room_nm FROM tb_classroom) cr
		  on cl.class_no = cr.class_no
		  
		<where>
			<if test="(!oname.equals('') and (oname eq 'A'.toString()))">			  
				and cii.name like concat('%', #{sname}, '%')
			</if>
			
			<if test="(!oname.equals('')) and oname eq 'B'.toString()">			  
				and app.name like concat('%', #{sname}, '%')
			</if>
			<if test="(!search_startdate.equals('') and (!search_enddate.equals('')))">		  
				and cii.class_enddate between #{search_startdate} and #{search_enddate}
			</if>

		</where>
		ORDER BY app.appraisal_no DESC
		LIMIT #{pageIndex}, #{pageSize} 
	</select>
	
	<select id="FBselectDetail" parameterType="map" resultType="map" >
	
		select app.appraisal_no ,cl.class_no, cir.class_nm, cir.name as t_name , cir.class_startdate, cir.class_enddate, cir.room_nm, app.name as s_name, app.appraisal_score, app.appraisal_content
		FROM tb_courselist cl
		inner join
		(select ap.appraisal_no, ap.class_no, ap.loginID, ap.appraisal_content, ap.appraisal_score, ui.name
		  FROM tb_appraisal ap
		  inner join
		  (select loginID, name FROM tb_userinfo) ui
		  on ap.loginID = ui.loginID) app
		on cl.class_no = app.class_no
		
		inner join
		(select ci.class_no, ci.class_nm, ci.class_startdate, ci.class_enddate, cr.room_nm, ui.name
		  FROM tb_classinfo ci
		  inner join
		  (select class_no, room_nm FROM tb_classroom) cr
		  on ci.class_no = cr.class_no
		  
		  inner join
		  (select loginID, name FROM tb_userinfo) ui
		  on ci.loginID = ui.loginID
		  ) cir
		  on cl.class_no = cir.class_no 
		  
		  where app.appraisal_no = #{appraisal_no}
	
	</select>
	
	<delete id="FBdelete" parameterType="int">
		delete from tb_appraisal
		where appraisal_no = #{appraisal_no}
	</delete>
</mapper>