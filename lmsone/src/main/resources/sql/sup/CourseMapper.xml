<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.happyjob.study.sup.dao.CourseDao">
	
	<!-- 과정 공지 목록 조회 -->
	<select id="listCourse" resultType="kr.happyjob.study.sup.model.CourseModel">
		/*kr.happy.study.sup.dao.CourseDao.listCourse*/
		SELECT		
				  c.class_no as class_no
			,	  u.name as name
			, 	c.class_nm as class_nm
			, 	c.class_startdate as class_startdate
			, 	c.class_enddate as class_enddate
			, 	c.recv_startdate as recv_startdate
			, 	c.recv_enddate as recv_enddate
			
		FROM	tb_classinfo c
		LEFT JOIN tb_userinfo u
    ON c.loginID = u.loginID
        
		<where>
		c.delete_yn != 'y'
		AND c.recv_enddate > NOW()
			<if test="(sname != null) and (!sname.equals(''))">
				<choose>
					<when
						test="oname eq 'name'.toString()">
						AND u.name Like CONCAT('%', #{sname}, '%')
					</when>
					<when
						test="oname eq 'class_nm'.toString()">
						AND c.class_nm LIKE CONCAT('%', #{sname}, '%')
					</when>
				</choose>
			</if>
		</where>
		
		ORDER BY c.recv_startdate DESC
		LIMIT #{pageIndex}, #{pageSize}
		
	</select>
	
	<!-- 과정 공지 목록 총 갯수 조회 -->
	<select id="countListCourse" resultType="int">
		/*kr.happy.study.sup.dao.CourseDao.countListCourse*/
		SELECT COUNT(1) AS tot_cnt 
		FROM tb_classinfo c
		LEFT JOIN tb_userinfo u
		ON c.loginID = u.loginID
			<where>
			c.delete_yn != 'y'
			AND c.recv_enddate > NOW() 
			<if test="(sname != null) and (!sname.equals(''))">
				<choose>
					<when
						test="oname eq 'name'.toString()">
						AND u.name Like CONCAT('%', #{sname}, '%')
					</when>
					<when
						test="oname eq 'class_nm'.toString()">
						AND c.class_nm LIKE CONCAT('%', #{sname}, '%')
					</when>
				</choose>
			</if>
		</where>
	</select>
	
	<!-- 과정 단건 조회 -->
	<select id="selectCourse" resultType="kr.happyjob.study.sup.model.CourseModel">
		/*kr.happy.study.sup.dao.CourseDao.selectCourse*/
		
		SELECT		
				c.class_nm as class_nm
			,	c.class_plan as class_plan	
			, 	DATE_FORMAT(c.class_startdate, '%Y-%m-%d') as class_startdate
			, 	DATE_FORMAT(c.class_enddate, '%Y-%m-%d') as class_enddate
			,	(SELECT count(loginID) FROM tb_courselist WHERE class_no = #{class_no}) as user_cnt
			,	c.class_no as class_no
			, 	c.class_totalcnt as class_totalcnt
			
		FROM	tb_classinfo c
		
		WHERE c.class_no = #{class_no}
		
	</select>
	
	<!-- 수강신청 -->
	<insert id="insertCourse">
		/*kr.happy.study.sup.dao.CourseDao.insertCourse*/
        
		INSERT INTO tb_courselist
		(
				class_no, loginID
		)
		VALUES
		(
				#{class_no}
			,	#{loginId}
			
		)		
	</insert>
	 
</mapper>